<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Konsumen - Kediri Mall</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { margin-top: 30px; max-width: 900px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header-mall { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .kediri { color: #c9a24d; font-weight: bold; font-size: 32px; }
        .mall { color: #1b7f3a; font-weight: bold; font-size: 32px; }
        
        .form-group label { font-weight: 600; color: #444; }
        .btn-simpan { background-color: #007bff; color: white; width: 100%; font-weight: bold; margin-top: 10px; }
        
        .table-responsive { margin-top: 30px; }
        .img-preview { 
            width: 60px; height: 60px; object-fit: cover; 
            border-radius: 5px; cursor: pointer; border: 1px solid #ddd;
        }
        .img-preview:hover { transform: scale(4); transition: 0.3s; position: relative; z-index: 100; }
        
        #status-msg { display: none; margin-top: 10px; }
        
        /* Loading Overlay */
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 20%; }
    </style>
</head>
<body>

<div id="loading"><h4>Memproses & Mengompres Gambar...</h4></div>

<div class="container">
    <div class="header-mall text-center">
        <span class="kediri">Kediri</span><span class="mall">Mall</span>
        <p class="text-muted">Aplikasi Pendataan Konsumen Offline</p>
    </div>

    <form id="formKonsumen">
        <div class="row">
            <div class="col-md-6 form-group">
                <label>Nama Konsumen:</label>
                <input type="text" id="nama" class="form-control" required placeholder="Nama Lengkap">
            </div>
            <div class="col-md-6 form-group">
                <label>Email:</label>
                <input type="email" id="email" class="form-control" required placeholder="contoh@gmail.com">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 form-group">
                <label>Nama Toko/Tenant:</label>
                <input type="text" id="toko" class="form-control" required placeholder="Nama Toko">
            </div>
            <div class="col-md-6 form-group">
                <label>No HP:</label>
                <input type="number" id="noHP" class="form-control" required placeholder="0812xxxx">
            </div>
        </div>

        <div class="form-group">
            <label>Jumlah/Nilai Belanja (Rp):</label>
            <input type="number" id="jumlah" class="form-control" required placeholder="Contoh: 200000">
        </div>

        <div class="form-group">
            <label>Foto Struk Belanja:</label>
            <input type="file" id="fotoStruk" class="form-control-file" accept="image/*">
            <small class="text-muted">Foto akan dikompres otomatis agar hemat memori.</small>
        </div>

        <button type="button" onclick="prosesSimpan()" class="btn btn-simpan btn-lg shadow-sm">üíæ Simpan Data</button>
    </form>

    <div id="status-msg" class="alert"></div>

    <div class="table-responsive">
        <h5 class="mb-3">üìã Data Tersimpan Lokal</h5>
        <input type="text" id="cari" class="form-control mb-3" placeholder="Cari nama atau toko..." onkeyup="renderTable()">
        
        <table class="table table-hover table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Foto</th>
                    <th>Nama</th>
                    <th>Toko</th>
                    <th>Jumlah</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="tabelBody">
                </tbody>
        </table>
    </div>

    <button onclick="kirimEmailSemua()" class="btn btn-success mt-3">üìß Kirim Laporan ke Email</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
    // Inisialisasi EmailJS (Ganti dengan Public Key Anda)
    (function() {
        emailjs.init("YOUR_PUBLIC_KEY"); 
    })();

    let database = JSON.parse(localStorage.getItem('db_konsumen')) || [];

    // Fungsi Utama Simpan
    function prosesSimpan() {
        const fileInput = document.getElementById('fotoStruk');
        const file = fileInput.files[0];
        
        if (!document.getElementById('nama').value) {
            alert("Nama harus diisi!");
            return;
        }

        document.getElementById('loading').style.display = 'block';

        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // PROSES KOMPRESI (Maksimal lebar 400px)
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Ubah ke Base64 dengan kualitas 0.7 (70%)
                    const base64Img = canvas.toDataURL('image/jpeg', 0.7);
                    simpanKeLocalStorage(base64Img);
                };
            };
        } else {
            simpanKeLocalStorage(""); // Simpan tanpa foto
        }
    }

    function simpanKeLocalStorage(fotoData) {
        const dataBaru = {
            id: Date.now(),
            nama: document.getElementById('nama').value,
            email: document.getElementById('email').value,
            toko: document.getElementById('toko').value,
            noHP: document.getElementById('noHP').value,
            jumlah: document.getElementById('jumlah').value,
            foto: fotoData,
            waktu: new Date().toLocaleString()
        };

        database.push(dataBaru);
        localStorage.setItem('db_konsumen', JSON.stringify(database));
        
        document.getElementById('formKonsumen').reset();
        document.getElementById('loading').style.display = 'none';
        tampilkanPesan("Data berhasil disimpan secara lokal!", "success");
        renderTable();
    }

    function renderTable() {
        const tabelBody = document.getElementById('tabelBody');
        const filter = document.getElementById('cari').value.toLowerCase();
        tabelBody.innerHTML = "";

        database.forEach((d, index) => {
            if (d.nama.toLowerCase().includes(filter) || d.toko.toLowerCase().includes(filter)) {
                let fotoHtml = d.foto ? `<img src="${d.foto}" class="img-preview">` : `<small>No Photo</small>`;
                
                tabelBody.innerHTML += `
                    <tr>
                        <td class="text-center">${fotoHtml}</td>
                        <td><b>${d.nama}</b><br><small>${d.email}</small></td>
                        <td>${d.toko}</td>
                        <td>Rp ${parseInt(d.jumlah).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="hapusData(${d.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }
        });
    }

    function hapusData(id) {
        if (confirm("Hapus data ini?")) {
            database = database.filter(item => item.id !== id);
            localStorage.setItem('db_konsumen', JSON.stringify(database));
            renderTable();
        }
    }

    function tampilkanPesan(msg, tipe) {
        const div = document.getElementById('status-msg');
        div.innerText = msg;
        div.className = `alert alert-${tipe}`;
        div.style.display = 'block';
        setTimeout(() => div.style.display = 'none', 3000);
    }

    function kirimEmailSemua() {
        if (database.length === 0) {
            alert("Tidak ada data untuk dikirim.");
            return;
        }

        // Contoh pengiriman data terakhir saja ke EmailJS
        const dataTerakhir = database[database.length - 1];
        
        const templateParams = {
            to_name: "Admin Kediri Mall",
            from_name: dataTerakhir.nama,
            message: `Laporan baru dari ${dataTerakhir.toko}. Nilai: Rp ${dataTerakhir.jumlah}`,
            struk_image: dataTerakhir.foto // Pastikan di template EmailJS ada variabel {{struk_image}}
        };

        emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
            .then(function() {
                alert("Laporan Berhasil Terkirim ke Email!");
            }, function(error) {
                alert("Gagal mengirim: " + JSON.stringify(error));
            });
    }

    // Jalankan tabel saat pertama buka
    renderTable();
</script>

</body>
</html>
