<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Konsumen - Kediri Mall</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { margin-top: 30px; max-width: 900px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header-mall { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .kediri { color: #c9a24d; font-weight: bold; font-size: 32px; }
        .mall { color: #1b7f3a; font-weight: bold; font-size: 32px; }
        .btn-simpan { background-color: #007bff; color: white; width: 100%; font-weight: bold; margin-top: 10px; }
        .img-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
        #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; text-align: center; padding-top: 20%; }
    </style>
</head>
<body>

<div id="loading"><h4>Sedang Memproses...</h4></div>

<div class="container">
    <div class="header-mall text-center">
        <span class="kediri">Kediri</span><span class="mall">Mall</span>
        <p class="text-muted" id="displayDevice">Memuat ID Perangkat...</p>
    </div>

    <form id="formKonsumen">
        <div class="row">
            <div class="col-md-6 form-group">
                <label>Nama Konsumen:</label>
                <input type="text" id="nama" class="form-control" required>
            </div>
            <div class="col-md-6 form-group">
                <label>Email:</label>
                <input type="email" id="email" class="form-control" required>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 form-group">
                <label>Nama Toko/Tenant:</label>
                <input type="text" id="toko" class="form-control" required>
            </div>
            <div class="col-md-6 form-group">
                <label>No HP (Mulai 08):</label>
                <input type="text" id="noHP" class="form-control" required placeholder="08...">
            </div>
        </div>

        <div class="form-group">
            <label>Jumlah/Nilai Belanja (Rp):</label>
            <input type="number" id="jumlah" class="form-control" required>
        </div>

        <div class="form-group">
            <label>Foto Struk Belanja:</label>
            <input type="file" id="fotoStruk" class="form-control-file" accept="image/*">
        </div>

        <button type="button" onclick="prosesSimpan()" class="btn btn-simpan btn-lg shadow-sm">üíæ Simpan Data Lokal</button>
    </form>

    <div class="table-responsive mt-4">
        <table class="table table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Foto</th>
                    <th>Nama</th>
                    <th>Toko</th>
                    <th>Jumlah</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="tabelBody"></tbody>
        </table>
    </div>

    <button onclick="kirimEmailSemua()" class="btn btn-success btn-block mt-3">üìß Kirim Laporan ke Email</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<script>
    // --- 1. INISIALISASI ---
    (function() {
        emailjs.init("H4GfR2mR_i8LVtxwa"); // Public Key Anda sudah terpasang
    })();

    function getDeviceId() {
        let id = localStorage.getItem('deviceId');
        if (!id) {
            id = prompt("Masukkan ID Perangkat (Contoh: HP-01):");
            if (!id) id = "Device-Unknown";
            localStorage.setItem('deviceId', id);
        }
        return id;
    }

    const DEVICE_ID = getDeviceId();
    document.getElementById('displayDevice').innerText = "ID Perangkat: " + DEVICE_ID;
    let database = JSON.parse(localStorage.getItem('db_konsumen')) || [];

    // --- 2. SIMPAN DATA & KOMPRESI FOTO ---
    function prosesSimpan() {
        const nama = document.getElementById('nama').value;
        const noHP = document.getElementById('noHP').value;
        const fileInput = document.getElementById('fotoStruk');
        const file = fileInput.files[0];

        if (!nama || !noHP) {
            alert("Nama dan No HP wajib diisi!");
            return;
        }

        // VALIDASI 08
        if (!noHP.startsWith('08')) {
            alert("Nomor HP harus dimulai dengan 08!");
            return;
        }

        document.getElementById('loading').style.display = 'block';

        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; // Ukuran kecil agar email tidak berat
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const base64Img = canvas.toDataURL('image/jpeg', 0.6); // Kualitas 60%
                    saveData(base64Img);
                };
            };
        } else {
            saveData("");
        }
    }

    function saveData(fotoData) {
        const data = {
            id: Date.now(),
            nama: document.getElementById('nama').value,
            email: document.getElementById('email').value,
            toko: document.getElementById('toko').value,
            noHP: document.getElementById('noHP').value,
            jumlah: document.getElementById('jumlah').value,
            foto: fotoData,
            deviceId: DEVICE_ID
        };
        database.push(data);
        localStorage.setItem('db_konsumen', JSON.stringify(database));
        document.getElementById('formKonsumen').reset();
        document.getElementById('loading').style.display = 'none';
        renderTable();
        alert("Data tersimpan di HP!");
    }

    function renderTable() {
        const body = document.getElementById('tabelBody');
        body.innerHTML = "";
        database.forEach(d => {
            body.innerHTML += `
                <tr>
                    <td>${d.foto ? `<img src="${d.foto}" class="img-preview">` : 'No Photo'}</td>
                    <td>${d.nama}</td>
                    <td>${d.toko}</td>
                    <td>Rp ${parseInt(d.jumlah).toLocaleString()}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="hapus(${d.id})">üóëÔ∏è</button></td>
                </tr>`;
        });
    }

    function hapus(id) {
        database = database.filter(i => i.id !== id);
        localStorage.setItem('db_konsumen', JSON.stringify(database));
        renderTable();
    }

    // --- 3. KIRIM KE EMAIL ---
    function kirimEmailSemua() {
        if (database.length === 0) return alert("Belum ada data!");

        let reportText = `LAPORAN DARI: ${DEVICE_ID}\n====================\n`;
        database.forEach((d, i) => {
            reportText += `${i+1}. ${d.nama} | ${d.toko} | Rp ${d.jumlah} | HP: ${d.noHP}\n`;
        });

        // Mengambil data terakhir untuk lampiran foto (EmailJS Free terbatas 1 lampiran)
        const dataTerakhir = database[database.length - 1];

        const params = {
            to_email: 'projectapp412@gmail.com',
            from_name: DEVICE_ID,
            message: reportText,
            struk_image: dataTerakhir.foto // Pastikan di Template EmailJS ada {{struk_image}}
        };

        // GANTI ID DI BAWAH INI SESUAI DASHBOARD EMAILJS KAMU
        emailjs.send('service_5mleabr', 'template_famzatq', params)
            .then(() => {
                alert("üöÄ Laporan Berhasil Dikirim!");
                if(confirm("Hapus data di HP agar tidak dobel?")) {
                    database = [];
                    localStorage.setItem('db_konsumen', JSON.stringify(database));
                    renderTable();
                }
            }, (err) => {
                alert("Gagal: " + JSON.stringify(err));
            });
    }

    renderTable();
</script>
</body>
</html>
